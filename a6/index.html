<html>
<head>
	<title>Assignment 6 - Jonathan Lee - jwl274 </title>
	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<style>
svg { border: solid black 1px; margin-top:30px;}

.point {
	font-size:1em;
}
.centroids {
	font-size:2em;
	fill:red;
	opacity:0.7;
}	

table {border-collapse: collapse;}
th {text-align: left;}

table, td,tr,th {
	border: 1px solid black; 
}

</style>
</head>

<body>
<h1>Assignment 6 - Jonathan Lee (jwl274)</h1>
<div id="p1"></div>
<script>
var height = 300;
var width = 300;
var padding = 40;

var svg = d3.select("#p1").append("svg").attr("height", height).attr("width", width);
var xScale, yScale;

var lines, text, centroidText;
var centroids, points;
var countries;

d3.csv("health.csv", function (error, data) {
	countries = data;
	points = countries.map(function (country) {
		// Create shorter variable names
		return {
			x: Math.log(Number(country["Doctors, per 10,000 population"])),
		 	y: Number(country["Health spending, % of GDP"]),
			label: country["Location"]
		};
	})
	.filter(function (point) {
		return ! isNaN(point.x) && ! isNaN(point.y);
	});

	xScale = d3.scale.linear()
	.domain(d3.extent(points, function (point) {
		return point.x;
	})).range([padding, width - padding]);
	
	yScale = d3.scale.linear()
	.domain(d3.extent(points, function (point) {
		return point.y;
	})).range([height - padding, padding]);

	//lines = svg.selectAll("line").data(points);

	centroids = new Array(1);
	var randomPoint = points[Math.floor(Math.random() * points.length)];
	centroids[0] = { x: randomPoint.x, y: randomPoint.y };
	points.forEach(function (point) { 
		point.cluster = 0;
	});

	centroidText = svg.selectAll(".centroids").data(centroids);

	// Each point has a line that is initially pointing to itself
/*	lines.enter().append("line")
	.attr("x1", function(d) { return xScale(d.x); })
	.attr("y1", function(d) { return yScale(d.y); })
	.attr("x2", function(d) { return xScale(d.x); })
	.attr("y2", function(d) { return yScale(d.y); })
	.style("stroke", "#aaa");
	*/
	text = svg.selectAll(".point").data(points);
	text.enter().append("text")
	.attr("class", "point")
	.attr("x", function(d) { return xScale(d.x); })
	.attr("y", function(d) { return yScale(d.y); })
	.text(function(d) {
		return String.fromCharCode(9634 + d.cluster);
	});

/*	lines.transition().duration(1000).attr("x2", function (point) {
		return xScale(centroids[point.cluster].x);
	})
	.attr("y2", function (point) {
		return yScale(centroids[point.cluster].y);
	});*/

	centroidText.enter().append("text")
	.attr("class", "centroids")
	.attr("x", function(d) { return xScale(d.x); })
	.attr("y", function(d) { return yScale(d.y); })
	.text(function(d,i) {
		return String.fromCharCode(9634 + i);
	});

	//Populating Arrays to Answer Question 3
	
	/*threshold1Array = populateClusterArray(threshold1);
	threshold2Array = populateClusterArray(threshold2);
	threshold3Array = populateClusterArray(threshold3);
	threshold4Array = populateClusterArray(threshold4);*/
	
});
</script>

<script>
function iterate(threshold) { 
	var clusterChanged =0;
	points.forEach(function (point) {
		var nearest;
		var shortestDistance = Number.MAX_VALUE;
		for (var i = 0; i < centroids.length; i++) {
			var c = centroids[i];
			
			var distance = Math.sqrt( 
				(c.x - point.x) * (c.x - point.x) +
				(c.y - point.y) * (c.y - point.y)
			);
		
			if (distance < shortestDistance) {
				shortestDistance = distance;
				nearest = i;
			}
		}

		if (shortestDistance > threshold) {
			centroids.push({ x: point.x , y: point.y});
			nearest = centroids.length-1;
		}

		if (point.cluster != nearest) { clusterChanged+=1;}

		point.cluster = nearest;

	});

	centroids.forEach(function (centroid, i) {
		var assignedPoints = 
			points.filter(function (point) { return point.cluster == i; });
		centroid.x = d3.mean(assignedPoints, function (point) { return point.x; });
		centroid.y = d3.mean(assignedPoints, function (point) { return point.y; });
	});
	return clusterChanged; 
}

function updateDisplay() { 
	//Update Points Text 


	//Update Cluster Text 
	centroidText = svg.selectAll(".centroids").data(centroids);

	centroidText.attr("x", function(d) { return xScale(d.x); })
	.attr("y", function(d) { return yScale(d.y); });

	centroidText.enter().append("text")
	.attr("class", "centroids")
	.attr("x", function(d) { return xScale(d.x); })
	.attr("y", function(d) { return yScale(d.y); })
	.text(function(d,i) {
		return String.fromCharCode(9634 + i);
	});


	centroidText.exit().remove();
/*
	lines.transition().duration(1000).attr("x2", function (point) {
		return xScale(centroids[point.cluster].x);
	})
	.attr("y2", function (point) {
		return yScale(centroids[point.cluster].y);
	});*/

	d3.selectAll(".point").text(function(d) {
	 return String.fromCharCode(9634 + d.cluster);
	});

}

function cluster(threshold, display) { 		
	centroids = new Array(1);
	var randomPoint = points[Math.floor(Math.random() * points.length)];
	centroids[0] = { x: randomPoint.x, y: randomPoint.y };
	points.forEach(function (point) { 
		point.cluster = 0;
	});

	console.log(centroids.length);

	var numberEmpty = 0;
	var rIterate = Number.MAX_VALUE;
	while (rIterate > 0) { 
		rIterate = iterate(threshold);
		display();
	}

	return centroids.length; 
}
</script>


<input id="slider" type="range" min="0.5" max="10.0" step="0.5" onmouseup="sliderFunction()"> 

</div>
<script>
function sliderFunction() { 
	var rangeThreshold = document.getElementById("slider").value;
	cluster(rangeThreshold,updateDisplay);
}

</script>
<script>
var threshold1 = 1;
var threshold2 = 2;
var threshold3 = 4;
var threshold4 = 7;

var threshold1Array = [];
var threshold2Array = [];
var threshold3Array = [];
var threshold4Array = [];

function populateClusterArray(thresholdValue) { 
	var populatedArray = [];
	for (var g=0;g<10;g++) { 
		populatedArray.push(cluster(thresholdValue,updateDisplay));
	}
	return populatedArray; 
}

</script>
<table>
<tr>
<th></th>
<th>T1</th>
<th>T2</th>
<th>T3</th>
<th>T4</th>
<th>T5</th>
<th>T6</th>
<th>T7</th>
<th>T8</th>
<th>T9</th>
<th>T10</th>
</tr>

<tr>
<th><script>document.write("Threshold: " + threshold1);</script></th>
<td>40</td>
<td>40</td>
<td>40</td>
<td>40</td>
<td>40</td>
<td>40</td>
<td>40</td>
<td>40</td>
<td>40</td>
<td>40</td>
</tr>

<tr>
<th><script>document.write("Threshold: " + threshold2);</script></th>
<td>7</td>
<td>7</td>
<td>7</td>
<td>7</td>
<td>7</td>
<td>7</td>
<td>7</td>
<td>7</td>
<td>7</td>
<td>7</td>
</tr>

<tr>
<th><script>document.write("Threshold: " + threshold3);</script></th>
<td>17</td>
<td>17</td>
<td>17</td>
<td>17</td>
<td>17</td>
<td>17</td>
<td>17</td>
<td>17</td>
<td>17</td>
<td>17</td>
</tr>

<tr>
<th><script>document.write("Threshold: " + threshold4);</script></th>
<td>3</td>
<td>3</td>
<td>3</td>
<td>3</td>
<td>3</td>
<td>3</td>
<td>3</td>
<td>3</td>
<td>3</td>
<td>3</td>
</tr>
</table>

<p>

</p>

</body> 
</html>